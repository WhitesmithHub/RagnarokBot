# -*- coding: utf-8 -*-
# app/core/campaign.py
from __future__ import annotations

# --- Тексты кампаний ---
_CAMPAIGNS = {
    "eclipse": {
        "title": "Затмение и возвращение вампирского князя",
        "brief": (
            "Луна померкла, и в городах заговорили о кланах ночи. "
            "Старинные печати трескаются, а чёрные письма находят адресатов даже в запертых домах. "
            "В преданиях говорится о князе, чья кровь тяжелее клятв и долгов, и о затмении, после которого "
            "он поднимет свой двор из мрака. Немногие решаются проверить, где кончаются слухи и начинается истина."
        ),
        "epic": (
            "🌘 <b>Затмение и возвращение вампирского князя</b>\n\n"
            "Небо словно забыло, как сиять, и лишь бледная каёмка луны скользит над крышами, как взгляд из прошлого. "
            "В трактирах шёпчут о печатях, что лопаются сами собой, и о письмах, написанных чёрными чернилами, "
            "которые находят тех, кто когда-то дал несбыточные обещания. Эти письма пахнут старым воском и чем-то ещё — "
            "словно железо, смешанное с хвойной смолой. Старики вспоминают имя князя, которого боялись звать по имени, "
            "и утверждают, что затмение — не случайность, а заранее назначенная встреча с долгами крови. "
            "Городские стражники обходят улицы парами, но их фонари тускнеют ближе к полуночи, будто ночь сама дует на огонь. "
            "На рынках под прилавками прячут осиновые колья, талисманы из серебряной проволоки и маленькие зеркала, "
            "которые обещают отражать не только лица. С каждой неделей пропадают люди: кто-то словно уходит с кем-то знакомым, "
            "кто-то — тихо, не оставив ни следа, ни тени. На окраинах замечают кареты без гербов, а в соборах — свечи, "
            "которые не коптят даже на ветру. И всё это тянет к одной точке на карте — к замку у Гнилого Перевала, "
            "где, по слухам, собирается двор, который не нуждается в дыхании. Если князь и правда возвращается, "
            "то кто-то должен встретить его на пороге — не как гость, а как приговор."
        ),
        "arrival_city": "Златоград",
        "arrival_suffix_text": (
            "к городским воротам, где камень хранит следы тысяч шагов и чужих историй. "
            "Кузнечные молоты отстукивают тревожный ритм, лавки закрываются раньше обычного, а на перекрёстках "
            "стоят люди с бледными лицами, шепча новости о ночных визитёрах. Ветер приносит запах смолы и свечного воска; "
            "над башнями висит тонкий обруч луны. На площади висит объявление: «Сохраняйте огни. Не открывайте двери после полуночи». "
            "Город ждёт не героя — город ждёт решимость. И ты чувствуешь, что опоздать здесь — значит позволить тени стать законом."
        ),
    },
    "dragon": {
        "title": "Пробуждение древнего дракона",
        "brief": (
            "На севере грохочут льды, а в трещинах гор шевелится забытая сила. "
            "Сёла пылают, караваны исчезают, старые баллады вновь поются шёпотом. "
            "Кто осмелится ступить в ледяную корону гор и разжечь древние руны?"
        ),
        "epic": (
            "❄️ <b>Пробуждение древнего дракона</b>\n\n"
            "Северный ветер приносит запах серы и холод, от которого трескаются стекла. "
            "В ущельях слышатся глухие вздохи, будто сама гора дышит сквозь снег. "
            "Шахтёры находят руду, что светится изнутри, и клянутся, что по ночам руда поёт. "
            "Пастухи видят следы, как лодьи, и не решаются идти за стадами к перевалам. "
            "Там, где когда-то стояли алтари каменных жрецов, люди ставят костры из сырого леса и молятся неизвестным именам. "
            "Городские власти клянутся, что всё под контролем, но глашатаи перешли на ночной режим. "
            "И потому, кто решится пойти туда, придётся выбирать между огнём и льдом в собственной груди."
        ),
        "arrival_city": "Стылогорск",
        "arrival_suffix_text": (
            "к воротам, затянутым инеем, и слышит, как победно звенит сталь кузнецов. "
            "На рынке торгуют мехами и каменной солью, но глаза купцов бегают — новости здесь холоднее снега. "
            "Таверны закрывают ставни ранним вечером: в окно может заглянуть не только ветер."
        ),
    },
    "plague": {
        "title": "Чумные тени",
        "brief": (
            "Болезнь не из плоти — из тени. Тени людей вытягиваются, нашёптывают желания и исчезают. "
            "Лекари бессильны, священники молчат. Придётся идти к источнику тумана."
        ),
        "epic": (
            "🦠 <b>Чумные тени</b>\n\n"
            "Туман поднимается не с рек, а из-под дверей. "
            "Люди ставят свечи на подоконники, и огарки тянутся, словно что-то пьёт их огонь. "
            "В ризницах хранят колокола, но не звонят: к кому молиться, если тень не признаёт свет? "
            "Письма от незнакомцев приходят без адреса, а внизу вместо подписи — нагар от свечи. "
            "Старшая знахарка говорит, что тени голодны и учатся быстрее детей. "
            "Только тот, кто не боится смотреть вниз, увидит, где туман становится дверью."
        ),
        "arrival_city": "Сумеречье",
        "arrival_suffix_text": (
            "к плацу, где даже днём стоят фонари, и каждый третий — с копотью на стекле. "
            "Здесь говорят тихо, и даже торговцы взвешивают слова вместе с товарами."
        ),
    },
}

_DEFAULT = "eclipse"

def welcome_text() -> str:
    return (
        "👋 Добро пожаловать в текстовую RPG!\n\n"
        "Выбери кампанию, создай героя и отправляйся в историю, где каждый шаг — выбор, "
        "а каждый выбор имеет последствия. Исследуй города и подземелья, торгуй на рынке, отдыхай в таверне "
        "и развивай умения."
    )

def campaigns_index() -> list[tuple[str, str]]:
    return [(cid, data["title"]) for cid, data in _CAMPAIGNS.items()]

def get_brief(campaign_id: str | None) -> str:
    cid = campaign_id or _DEFAULT
    data = _CAMPAIGNS.get(cid, _CAMPAIGNS[_DEFAULT])
    return f"📜 <b>{data['title']}</b>\n\n{data['brief']}"

def get_epic(campaign_id: str | None) -> str:
    cid = campaign_id or _DEFAULT
    data = _CAMPAIGNS.get(cid, _CAMPAIGNS[_DEFAULT])
    return data["epic"]

def arrival_city_name(campaign_id: str | None) -> str:
    cid = campaign_id or _DEFAULT
    data = _CAMPAIGNS.get(cid, _CAMPAIGNS[_DEFAULT])
    return data["arrival_city"]

def _is_female(gender: str, name: str) -> bool:
    if gender == "female":
        return True
    if gender == "male":
        return False
    nm = (name or "").strip().lower()
    fem_endings = ("ёчка","очка","ечка","юшка","онька","енька","инка","улька","анька","янка","а","я")
    return any(nm.endswith(suf) for suf in fem_endings)

def arrival_text(hero_name: str, gender: str, campaign_id: str | None) -> str:
    cid = campaign_id or _DEFAULT
    data = _CAMPAIGNS.get(cid, _CAMPAIGNS[_DEFAULT])
    fem = _is_female(gender, hero_name)
    verb = "подошла" if fem else "подошёл"
    city = data["arrival_city"]
    return f"🏘️ <b>{city}</b>\n\n{hero_name} {verb} {data['arrival_suffix_text']}"
